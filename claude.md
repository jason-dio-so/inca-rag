# 보험 약관 비교 RAG 시스템

## 프로젝트 목적
보험사(insurer) + 상품(product) + 플랜(plan) 단위로 약관/사업방법서/상품요약서/가입설계서를 구조화하고, 비교조회(coverage comparison)를 정확하게 수행하는 시스템

---

## 1. 기술 스택 / 전제
- Backend: FastAPI (Python)
- DB: Postgres + pgvector
- Vector Search + Metadata Filter 병행
- **보험사 영문 명칭은 `carrier`가 아니라 `insurer`를 사용한다 (중요)**
- IDE는 VS Code, 코드 실행은 로컬 Docker 환경

---

## 2. 도메인 모델 (핵심 개념)

### (1) insurer
- 보험사 (예: 삼성화재, 롯데손보, DB손보)

### (2) product
- 보험 상품 (보험사별로 관리)
- 같은 상품이라도 version(예: 2511) 존재

### (3) product_plan (매우 중요)
- 같은 상품 내의 플랜/변형
- 예:
  - 남/여
  - 연령대 (40세 이하 / 41세 이상)
  - 종(1종/3종/4종), 형(1형/2형)
- **plan_id가 NULL이면 "공통 문서"**

### (4) document
- 약관 / 사업방법서 / 상품요약서 / 가입설계서
- sha256으로 동일 문서 중복 방지

### (5) chunk
- 문서를 잘라 만든 최소 검색 단위
- pgvector embedding 포함
- JSONB meta에 coverage_code(담보 표준코드) 포함

---

## 3. 핵심 설계 원칙

### A. Plan 자동 선택
- 질의에서 성별/나이를 추출
- 가능한 경우 plan_id 자동 선택
- 검색은 항상: **plan 우선 → 공통(plan_id IS NULL) fallback**

### B. 비교조회 전략
- 단일조회: insurer + product 기준
- 비교조회: 여러 insurer+product를 받아 타겟별로 검색 후 병합
- **타겟별 쏠림 방지를 위해 quota 기반 병합 사용**

### C. 담보 비교는 keyword가 아니라 coverage_code 기준
- 예:
  - `CIS_CARCINOMA` = 제자리암
  - `BORDERLINE_TUMOR` = 경계성종양
- `chunk.meta.entities.coverage_code`에 사전 주입

---

## 4. 현재 준비된 상태
- DB schema.sql (Postgres + pgvector) 초안 있음
- FastAPI retrieval/search, compare-targets 설계 완료
- plan_selector 로직(질의 → gender/age 추출) 있음
- 임베딩은 현재 더미 → 실제 임베딩으로 교체 예정

---

## 5. 쉬운요약서 처리 규칙 (고정)

### 규칙 1. doc_type 고정
- 파일명에 `쉬운요약서`, `쉬운 요약서`, `easy`가 포함되어도 **doc_type은 항상 `상품요약서`**

### 규칙 2. subtype으로만 구분
```yaml
# 쉬운요약서
doc_type: 상품요약서
document:
  meta:
    subtype: easy

# 일반 상품요약서
doc_type: 상품요약서
document:
  meta:
    subtype: standard
```

### 규칙 3. 폴더 구조
- 쉬운요약서 PDF는 반드시 `data/<INSURER>/상품요약서/` 아래
- `data/<INSURER>/쉬운요약서/` 폴더는 금지

### 규칙 4. retrieval/비교조회 전제
- `WHERE doc_type = '상품요약서'`를 기준으로 동작
- 쉬운요약서를 doc_type으로 분리하면 안 됨

### 규칙 5. 적용 범위
- 삼성뿐 아니라 모든 보험사의 easy summary에 동일 적용

---

## 6. 개발 규칙
- 기존 설계를 임의로 단순화하거나 바꾸지 말 것
- 보험 도메인 특성을 고려하여 구현
- 불확실한 부분은 반드시 질문 후 진행

본 문서는 본 프로젝트(보험 약관·담보 비교 RAG + Ontology)에서  
Claude가 수행하는 모든 작업에 대해  
세션 변경, 작업 종류와 무관하게 **항상·반드시·예외 없이** 준수해야 하는  
최상위 원칙(헌법)이다.

본 문서는 개별 STEP 지시문보다 **항상 우선**한다.

---

## 1. 의미 규칙 외부화 원칙 (절대 규칙)

- 의미, 정책, 비즈니스 판단과 관련된 모든 규칙은 코드에 하드코딩하지 않는다.
- 다음 유형은 반드시 테이블 또는 설정 파일(yaml 등)로 관리한다.
  - coverage_code ↔ 담보명 / alias
  - coverage_code → domain(암/상해/뇌/심혈관/수술 등)
  - domain → 대표 담보 우선순위
  - coverage_code → 메인/파생 담보 구분
  - 질의 키워드 → domain 매핑
  - 문서 우선순위(doc_type_priority)
  - 비교/판단에 사용되는 정책적 기준
- 코드 내부 dict, 상수, if/else 로 의미 판단을 구현하는 것을 금지한다.
- 코드는 설정 파일을 로드하여 **참조만** 수행한다.

---

## 2. 로직과 규칙의 분리 원칙

- 코드는 “어떻게 처리할지(알고리즘/흐름)”만 담당한다.
- “무엇이 맞는지(의미/정책)”는 데이터(설정/테이블)가 결정한다.
- 규칙 변경 시 코드 수정 없이 설정 변경만으로 동작이 바뀌어야 한다.

---

## 3. Domain(담보/질병 계열) 강제 원칙

- 질의에서 특정 담보/질병 계열(domain)이 판별되면,
  대표 담보 및 연관 담보는 해당 domain에 속한 것만 허용한다.
- 다른 domain의 담보는:
  - 대표 ❌
  - 연관 담보 ❌
  - 화면 노출 ❌
- 대표 담보 선택 실패는 RAG 문제가 아니라 **설계 결함**으로 간주한다.

---

## 4. 메인 담보 우선 원칙

- 동일 domain 내에서는 항상 “메인 담보”를 대표로 우선 선택한다.
- 파생 담보(유사암, 재진단암, 조건 담보 등)는 연관 담보로만 노출한다.
- 단, 질의가 명시적으로 파생 담보를 요청한 경우에만
  파생 담보를 대표로 선택할 수 있다.

---

## 5. 문서 우선순위 원칙

- 법적 정의, 보장 여부, 조건 판단은 항상 약관을 최우선으로 한다.
- 사업방법서, 상품요약서, 가입설계서는 보조 근거로만 사용한다.
- 이 문서 우선순위 또한 코드 하드코딩이 아니라 설정으로 관리한다.

---

## 6. Git 반영 원칙 (필수)

- 모든 작업은 반드시 git에 반영되어야 한다.
- 작업 결과에는 다음이 포함되어야 한다.
  - 코드 변경
  - 설정/테이블 변경
  - 문서 변경
- 커밋 메시지에는 STEP 또는 U-번호를 반드시 포함한다.
  - 예: `feat: STEP 2.7-α representative coverage selection`

---

## 7. status.md 업데이트 원칙 (필수)

- 모든 작업 완료 시 status.md를 반드시 업데이트한다.
- 포함해야 할 최소 내용:
  - 수행한 STEP / 작업명
  - 작업 요약
  - 완료 여부
  - 주요 변경 사항
  - 관련 커밋 해시
- status.md는 “현재 시스템 상태”를 제3자가 즉시 이해할 수 있어야 한다.

---

## 8. 회귀 방지 원칙

- 구조 개선, 리팩토링, 외부화 작업은 기능 결과를 변경하지 않는 것을 원칙으로 한다.
- 기존 eval / unit test는 반드시 재실행한다.
- 결과 변경이 필요한 경우, 반드시 사전에 사용자와 합의한다.

---

## 9. 임시 구현 금지 원칙

- “임시로”, “일단 이렇게”라는 구현은 허용되지 않는다.
- 임시 대응이 필요한 경우에도
  최종 구조(테이블/설정) 형태를 먼저 설계한 뒤 구현한다.

---

## 10. 보고 및 산출물 원칙

- 작업 완료 보고에는 반드시 다음을 포함한다.
  - 변경된 파일 목록
  - 새로 생성·수정된 설정/테이블
  - 테스트 결과
  - 커밋 해시
- 추상적인 완료 보고는 허용하지 않는다.

---

## 11. 세션 시작 준수 원칙

- 새 세션에서 작업을 시작할 경우,
  반드시 본 문서를 먼저 읽고 준수 사항을 인지한 뒤 작업을 진행한다.
- 본 문서와 충돌하는 지시는 수행하지 않는다.

---

### 본 문서는 프로젝트 헌법(Constitution)으로 간주한다.
### 본 문서에 위배되는 구현은 허용되지 않는다.