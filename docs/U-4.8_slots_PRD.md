# U-4.8 PRD: Comparison Slots v0.1 (보험 비교 RAG)

## Background
현재 U-4.7 데모는 A2 정책(약관은 비교 계산 미사용, 정의/근거 확인용) 기반으로 동작한다.
하지만 “비교” 결과가 추상적이며, 사용자가 원하는 구체 비교(금액/조건/유무)가 부족하다.
LLM이 비교축을 즉흥적으로 만들지 않도록 시스템이 비교 슬롯(Comparison Slots)을 제공해야 한다.

## Goal
- 특정 담보(우선 1개: 암진단비) 질문에 대해
  - 비교 슬롯 단위로 (삼성 vs 메리츠) 결과가 출력되게 한다.
- 슬롯별로 “값(value)”과 “근거(evidence)”가 연결되게 한다.
- A2 정책 유지: 약관은 비교 계산에 사용하지 않되, 정의/면책 등 설명 근거로는 제공 가능.

## Non-goals
- 모든 담보 전체 적용 (이번 사이클은 1개 담보군만)
- 완벽한 NLP (일단 슬롯 기반 비교가 나오게 하는 것이 목적)

## Definitions
- insurer: 보험사
- coverage_code: 표준화된 담보 코드
- plan: I/I-1 자동선택 결과
- comparison slot: 비교 가능한 항목(예: 지급금액, 지급조건 요약, 보장범위(정의), 대기기간 등)

## Slot Spec v0.1 (암진단비)
슬롯 예시:
1) payout_amount (comparable=true, source=가입설계서 우선)
2) payout_condition_summary (comparable=true, source=상품요약서/사업방법서 우선, LLM 보정 허용)
3) diagnosis_scope_definition (comparable=false, source=약관; 정의 근거용)
4) waiting_period (comparable=false, source=약관; 면책/대기기간 설명용)
5) existence_status (comparable=true, source=가입설계서/요약서/사업방법서; found/not_found + 이유)

## Data Model
- 새로운 테이블 또는 기존 추출 테이블 확장으로 slot 결과 저장:
  - (insurer, product, plan, coverage_code, slot_key, slot_value, unit, normalized_value, confidence, evidence_refs[])
- evidence_refs는 chunk_id/page/bbox 등 기존 PDF 하이라이트 참조를 재사용

## API Changes
- compare response에 `slots[]` 추가:
  - slot_key, label, comparable, 삼성(value, confidence, evidence_refs), 메리츠(...), diff_summary
- Policy 탭은 기존처럼 유지하되 slot과 연동된 policy evidence만 우선 노출(TopK 3)

## UI Changes
- 좌측: 자연어 요약 + 슬롯 테이블(핵심 3~5개 슬롯)
- 우측: Evidence는 슬롯별로 필터링 가능(탭/드롭다운)

## Acceptance Criteria
AC1. “삼성과 메리츠의 암진단비 비교해줘” 입력 시
- 최소 3개 슬롯(payout_amount, existence_status, payout_condition_summary)이 화면에 나타난다.
AC2. 메리츠 값이 없으면 slot 단위로 "not_found" + 어떤 문서군에서 없었는지(reason)가 표시된다.
AC3. evidence는 슬롯별로 최대 3개 기본 노출(더보기 가능), score=0.00 같은 혼동 표현 제거(N/A로 대체).
AC4. demo_up.sh 스모크 유지 + U-4.8 전용 10개 회귀 테스트 PASS.

## Deliverables
- ontology/comparison_slots.v0.1.yaml
- DB migration (alembic or sql)
- API schema update
- UI update
- eval/goldset_u48_slots.csv + eval rules